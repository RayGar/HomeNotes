/* index.js: HomeNote's lambda function */


"use strict";

var Alexa = require("alexa-sdk");           
const AWS = require('aws-sdk');
const docClient = new AWS.DynamoDB.DocumentClient({region: 'us-east-1'});

var reask = "Now what action do you wish to take next?";                                            //macrodefinition
var reprompt = "Sorry I did not hear that. Please repeat the action you wish to take.";




var handlers = {																					// this is an object that handles the intent requests
    "LaunchRequest": function () {
      
        if(Object.keys(this.attributes).length === 0) {
            this.attributes['currUser'] = "";
            this.response.speak("Welcome for the first time to home notes... What action do you wish to take?")
                .listen(reprompt);
        } else {
            this.response.speak("Welcome back to home notes ... What action do you wish to take?")
                .listen(reprompt);
        }
	    
	    
	this.emit(':responseReady');
  },
  
  
	"LeaveNoteIntent": function() {
	    var currNote = this.event.request.intent.slots.Note.value;
		this.attributes['currNote'] = currNote;
		
		var recievingUser = this.event.request.intent.slots.User.value;
		this.attributes['currUser'] = recievingUser;
		
		this.response.speak("I will now leave the message: " + currNote + " to " + recievingUser);
		
		//db.write(currNote,currUser);
		
		this.emit(':responseReady');
	},
  
	"DeleteNotesIntent": function() {
		this.response.speak("You have chosen to delete a note. " + reask)
			.listen(reprompt);
		this.emit(':responseReady');
	},
	
	"PlayNotesIntent": function() {
		this.response.speak("You have chosen to play the notes left to you." + reask)
			.listen(reprompt);
		this.emit(':responseReady');
	},
	
	'RegisterUserIntent': function() {
		var currUser = this.event.request.intent.slots.User.value;
		this.attributes['currUser'] = currUser;
		
		
		
		    
		    
		var params = {
            Item: {
                User: currUser,
                message: "Buy milk"
            },
      
            TableName: 'Notes'
        };
    
            docClient.put(params, function(err, data){
            if(err){
                console.log(err,null);
            }else{
                console.log(null,data);
            }
        });
        
        this.response.speak("I shall now address you as " + currUser + ". " + reask);
        
		
		this.emit(':responseReady');
	},
	
	  
	  
   // Stop
  'AMAZON.StopIntent': function() {
      this.response.speak('Ok, let\'s play again soon.');
      this.emit(':responseReady');
  },

  // Cancel
  'AMAZON.CancelIntent': function() {
      this.response.speak('Ok, let\'s play again soon.');
      this.emit(':responseReady');
  },

  // Save state
  'SessionEndedRequest': function() {
    console.log('session ended!');
    this.emit(':saveState', true);
  }
};

exports.handler = function(event, context, callback) {												//every lambda function needs this, not just Alexa, AWS calls it everytime someone uses our skill
  var alexa = Alexa.handler(event, context);														//setup the Alexa object
    alexa.registerHandlers(handlers);																//register the handlers we wrote in the preceding block
    alexa.execute();	//calls the Alexa code
    
    
    
};